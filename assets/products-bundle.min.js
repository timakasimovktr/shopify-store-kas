document.addEventListener('DOMContentLoaded', function() {
  console.log("loaded")
  $(document).on('click', '.bundle-container .btn-show-items', function(e) {
    $(this).closest(".bundle-container").find(".products-container").slideToggle();
    $(this).find("img").toggleClass("open");
    if ($(this).find("img").hasClass("open")) {
      $(this).find("i").html("hide items &nbsp;&nbsp;");
    } else {
      $(this).find("i").html("show items &nbsp;&nbsp;");
    }
    e.preventDefault();
  });

  $(document).on('click', '.bundle-container .btn-remove-bundle', function(e) {
    let variantId = $(this).attr("data-variant-id");
    let variantArray = variantId.split(',');
    let dataHash = new Object();
    let bundleToRemove = $(this).closest(".bundle-container");
    const monogramId = bundleToRemove.find(`.product[data-monogram]`)
    if(monogramId) {
      monogramVariantId = monogramId[0].dataset.monogram
      if(monogramVariantId) {
        const $bundleContainer = $(this).closest('.bundle-container')
        const currentQuantity = $(this).closest('.mainBundle').find('input.js-counter-field-bundle').val()
        let monogramQuantity = $bundleContainer.find('input.property-monogramQuantity')[0].value || 1
        const monoInput = $(document).find(`.cart .product[data-variant-id="${monogramVariantId}"] .js-counter-field`)[0]
        oldMonoQuantity = monoInput.dataset.prevVale || 0;
        monoInput.setAttribute('data-prev-vale', currentQuantity * monogramQuantity);
        dataHash[monogramVariantId] = oldMonoQuantity - currentQuantity * monogramQuantity
      }
    }

    variantArray.forEach(function(variant) {
      dataHash[variant] = 0;
    });

    $.ajax({
      url: '/cart/update.js',
      type: 'POST',
      dataType: 'json',
      data: JSON.stringify({ updates: dataHash }),
      contentType: "application/json",
      success: function(textStatus, status) {
        $.ajax({
          url: '/cart.js',
          type: 'get',
          dataType: 'json',
          success: function(response) {
            let jsonResponse = JSON.parse(JSON.stringify(response));
            bundleToRemove.slideToggle("fast", function() {
              $(this).remove();
            });
            $(".cart__link > span").html(jsonResponse.item_count);
            $("#cart-inner .cart__inner-actions .money").html("$ " + ((parseFloat(jsonResponse.total_price) / 100)).toFixed(2));
            if (parseInt(jsonResponse.item_count) == 0) {
              $("#cart-inner > form").remove();
              $("#cart-inner").append('<div class="cart-empty"><h4>Your Cart</h4><p>Your cart is currently empty.</p><p>Continue browsing <a href="/">here</a>.</p></div>');
            }
          }
        });
      }
    });
    e.preventDefault();
  });
});